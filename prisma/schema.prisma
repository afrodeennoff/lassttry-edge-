generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider  = "postgresql"
  schemas   = ["public"]
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id               String              @id @default(cuid())
  email            String              @unique
  auth_user_id     String              @unique
  isFirstConnection Boolean             @default(true)
  isBeta           Boolean             @default(false)
  language         String              @default("en")
  etpToken         String?
  thorToken        String?
  referral         Referral?
  subscription     Subscription?
  dashboardLayout  DashboardLayout?

  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  accounts              Account[]
  businesses            Business[]
  teams                 Team[]
  teamMemberships       TeamMember[]
  organizations         Organization[]
  teamSubscriptions     TeamSubscription[]
  businessSubscriptions BusinessSubscription[]
  comments              Comment[]
  groups                Group[]
  moods                 Mood[]
  notifications         Notification[]
  orders                Order[]
  posts                 Post[]
  synchronizations      Synchronization[]
  tags                  Tag[]
  votes                 Vote[]

  @@index([email])
  @@schema("public")
}

model Referral {
  id              String   @id @default(uuid())
  userId          String   @unique
  slug            String   @unique
  referredUserIds String[] @default([])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([slug])
  @@schema("public")
}

model Subscription {
  id          String    @id @unique @default(uuid())
  email       String    @unique
  plan        String
  status      String    @default("ACTIVE")
  interval    String?

  userId      String    @unique
  endDate     DateTime?
  trialEndsAt DateTime?

  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@schema("public")
}

model DashboardLayout {
  id        String   @id @default(uuid())
  userId    String   @unique

  desktop   Json     @default("[]")
  mobile    Json     @default("[]")

  version   Int      @default(1)
  checksum  String?  
  deviceId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user                User                    @relation(fields: [userId], references: [auth_user_id], onDelete: Cascade)
  versionHistory      LayoutVersion[]

  @@index([userId])
  @@schema("public")
}

model LayoutVersion {
  id          String   @id @default(uuid())
  layoutId    String

  desktop     Json     @default("[]")
  mobile      Json     @default("[]")
  
  version     Int
  checksum    String
  description String?
  
  deviceId    String
  changeType  String   @default("manual") // manual, auto, migration, conflict_resolution
  
  createdAt   DateTime @default(now())

  layout      DashboardLayout @relation(fields: [layoutId], references: [id], onDelete: Cascade)

  @@index([layoutId])
  @@index([layoutId, version])
  @@schema("public")
}

// ============================================================================
// TRADING CORE
// ============================================================================

model Account {
  id               String   @id @unique @default(uuid())
  number           String
  userId           String

  propfirm         String   @default("")
  accountSize      String?
  accountSizeName  String?

  startingBalance  Float    @default(0)
  balanceRequired  Float?
  drawdownThreshold Float   @default(0)
  dailyLoss        Float    @default(0)
  profitTarget     Float    @default(0)
  buffer           Float    @default(0)
  considerBuffer   Boolean  @default(true)

  trailingDrawdown Boolean  @default(false)
  trailingStopProfit Float?
  trailing         String?

  isPerformance    Boolean  @default(false)
  evaluation       Boolean  @default(true)

  payoutCount      Int      @default(0)
  minPayout        Float?
  maxPayout        String?
  profitSharing    Float?
  payoutBonus      Float?
  payoutPolicy     String?

  consistencyPercentage Float? @default(30)
  minTradingDaysForPayout Int?
  minDays          Int?
  minPnlToCountAsDay Float?

  activationFees   Float?
  price            Float?
  priceWithPromo   Float?
  promoPercentage  Float?
  promoType        PromoType?

  tradingNewsAllowed Boolean @default(true)
  rulesDailyLoss   String?

  autoRenewal       Boolean  @default(false)
  paymentFrequency  PaymentFrequency?
  renewalNotice     Int?
  nextPaymentDate   DateTime?

  isRecursively     String?
  maxFundedAccounts Int?

  resetDate         DateTime?
  shouldConsiderTradesBeforeReset Boolean @default(true)

  groupId           String?
  group             Group?   @relation(fields: [groupId], references: [id])

  createdAt         DateTime @default(now())

  trades            Trade[]
  payouts           Payout[]

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([number, userId])
  @@index([number])
  @@index([groupId])
  @@index([nextPaymentDate])
  @@schema("public")
}

model Trade {
  id              String   @id @unique @default(uuid())
  accountNumber   String
  userId          String

  instrument      String
  side            String?  @default("")
  quantity        Int

  entryPrice      Float
  closePrice      Float
  pnl             Float
  commission      Float    @default(0)

  entryId         String?  @default("")
  closeId         String?  @default("")

  entryDate       String
  closeDate       String

  timeInPosition  Float    @default(0)

  comment         String?
  tags            String[] @default([])
  groupId         String?  @default("")

  imageBase64     String?
  imageBase64Second String?
  images          String[] @default([])
  videoUrl        String?

  createdAt       DateTime @default(now())

  account         Account  @relation(fields: [accountNumber, userId], references: [number, userId], onDelete: Cascade)

  @@index([accountNumber])
  @@index([groupId])
  @@index([entryDate])
  @@index([closeDate])
  @@index([userId, accountNumber, instrument])
  @@schema("public")
}

model Group {
  id        String   @id @default(uuid())
  name      String
  userId    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts  Account[]
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
  @@index([userId])
  @@schema("public")
}

model Payout {
  id            String   @id @default(uuid())
  accountId     String
  accountNumber String

  amount        Float
  status        String   @default("PENDING")

  date          DateTime
  createdAt     DateTime @default(now())

  account       Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountNumber])
  @@schema("public")
}

model Order {
  id                String   @id @default(uuid())
  accountId         String
  orderId           String   @unique
  userId            String

  symbol            String
  instrumentType    String
  orderAction       String

  quantity          Int
  averageFilledPrice Float
  isOpeningOrder    Boolean

  time              DateTime

  createdAt         DateTime @default(now())

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([userId])
  @@schema("public")
}

model Synchronization {
  id             String    @id @default(uuid())
  userId         String
  service        String
  accountId      String

  lastSyncedAt   DateTime
  dailySyncTime  DateTime?

  token          String?
  tokenExpiresAt DateTime?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, service, accountId])
  @@index([userId])
  @@index([service])
  @@schema("public")
}

// ============================================================================
// ANALYTICS & MARKET DATA
// ============================================================================

model TickDetails {
  id        String @id @unique @default(uuid())
  ticker    String
  tickValue Float
  tickSize  Float

  @@schema("public")
}

model TradeAnalytics {
  id                 String   @id @default(uuid())
  tradeId            String   @unique

  mae                Float    @default(0)
  mfe                Float    @default(0)
  entryPriceFromData Float?
  priceDifference    Float?
  riskRewardRatio    Float?
  efficiency         Float?

  dataSource         String   @default("DATABENTO")

  computedAt         DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([tradeId])
  @@index([computedAt])
  @@schema("public")
}

model HistoricalData {
  id             String   @id @default(uuid())
  symbol         String
  databentSymbol String
  timestamp      DateTime

  open           Float
  high           Float
  low            Float
  close          Float
  volume         Int

  dataSource     String   @default("DATABENTO")
  createdAt      DateTime @default(now())

  @@unique([symbol, databentSymbol, timestamp])
  @@index([symbol])
  @@index([databentSymbol])
  @@index([timestamp])
  @@schema("public")
}

model FinancialEvent {
  id          String   @id @default(uuid())
  title       String
  date        DateTime

  importance  String
  type        String
  description String?

  sourceUrl   String?
  country     String?
  lang        String   @default("fr")
  timezone    String   @default("UTC")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([title, date, lang, timezone])
  @@index([date])
  @@schema("public")
}

// ============================================================================
// COLLABORATION
// ============================================================================

model Business {
  id                   String                @id @default(uuid())
  name                 String
  userId               String

  traderIds            String[]              @default([])

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  businessSubscription BusinessSubscription?
  invitations          BusinessInvitation[]
  managers             BusinessManager[]

  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
  @@index([userId])
  @@schema("public")
}

model BusinessSubscription {
  id          String    @id @unique @default(uuid())
  email       String    @unique
  plan        String
  status      String    @default("ACTIVE")
  interval    String?

  userId      String    @unique
  businessId  String    @unique
  endDate     DateTime?
  trialEndsAt DateTime?

  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([userId])
  @@index([businessId])
  @@schema("public")
}

model BusinessInvitation {
  id         String   @id @default(uuid())
  businessId String
  email      String
  invitedBy  String
  status     String   @default("PENDING")

  expiresAt  DateTime @default(dbgenerated("(now() + '7 days'::interval)"))
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, email])
  @@index([businessId])
  @@index([email])
  @@index([status])
  @@schema("public")
}

model BusinessManager {
  id         String   @id @default(uuid())
  businessId String
  managerId  String
  access     String   @default("viewer")

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, managerId])
  @@index([businessId])
  @@index([managerId])
  @@schema("public")
}

model Team {
  id               String       @id @default(uuid())
  name             String
  userId           String
  organizationId   String?

  traderIds        String[]     @default([])

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  organization     Organization? @relation(fields: [organizationId], references: [id])
  teamSubscription TeamSubscription?
  members          TeamMember[]
  invitations      TeamInvitation[]
  managers         TeamManager[]
  analytics        TeamAnalytics[]

  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
  @@index([userId])
  @@index([organizationId])
  @@schema("public")
}

model TeamSubscription {
  id          String    @id @unique @default(uuid())
  email       String    @unique
  plan        String
  status      String    @default("ACTIVE")
  interval    String?

  userId      String    @unique
  teamId      String    @unique
  endDate     DateTime?
  trialEndsAt DateTime?

  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([userId])
  @@index([teamId])
  @@schema("public")
}

model TeamInvitation {
  id        String     @id @default(uuid())
  teamId    String
  email     String
  invitedBy String
  status    String     @default("PENDING")
  role      MemberRole @default(TRADER)

  expiresAt DateTime   @default(dbgenerated("(now() + '7 days'::interval)"))
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, email])
  @@index([teamId])
  @@index([email])
  @@index([status])
  @@schema("public")
}

model TeamManager {
  id        String   @id @default(uuid())
  teamId    String
  managerId String
  access    String   @default("viewer")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, managerId])
  @@index([teamId])
  @@index([managerId])
  @@schema("public")
}

model TeamMember {
  id         String     @id @default(cuid())
  teamId     String
  userId     String
  role       MemberRole @default(TRADER)

  joinedAt   DateTime   @default(now())
  isActive   Boolean    @default(true)
  accountIds String[]   @default([])
  settings   Json?      @default("{}")

  team       Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@index([role])
  @@schema("public")
}

model TeamAnalytics {
  id           String   @id @default(cuid())
  teamId       String
  period       String  @default("monthly")

  totalPnl     Float    @default(0)
  totalTrades  Int      @default(0)
  winRate      Float    @default(0)
  averageRr    Float    @default(0)
  bestMemberId String?
  bestMemberPnl Float?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  team         Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, period])
  @@index([teamId])
  @@schema("public")
}

model Organization {
  id        String   @id @default(cuid())
  name      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teams     Team[]
  users     User[]

  @@index([name])
  @@schema("public")
}

// ============================================================================
// USER CONTENT
// ============================================================================

model Post {
  id          String     @id @default(uuid())
  title       String
  content     String
  type        PostType   @default(FEATURE_REQUEST)
  status      PostStatus @default(OPEN)
  userId      String

  screenshots String[]   @default([])

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  comments    Comment[]
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes       Vote[]

  @@index([userId])
  @@index([type])
  @@index([status])
  @@schema("public")
}

model Comment {
  id        String    @id @default(uuid())
  content   String
  postId    String
  userId    String
  parentId  String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
  @@index([parentId])
  @@schema("public")
}

model Vote {
  id        String   @id @default(uuid())
  type      VoteType
  postId    String
  userId    String

  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@schema("public")
}

model Mood {
  id                   String   @id @default(uuid())
  userId               String
  day                  DateTime
  mood                 String

  emotionValue         Int      @default(50)
  hasTradingExperience Boolean?

  conversation         Json?
  journalContent       String?
  selectedNews         String[] @default([])

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, day])
  @@index([userId])
  @@index([day])
  @@schema("public")
}

model Tag {
  id          String   @id @default(uuid())
  name        String
  description String?
  color       String?  @default("#CBD5E1")
  userId      String

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
  @@index([userId])
  @@schema("public")
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String

  readAt      DateTime?
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@schema("public")
}

// ============================================================================
// SHARED CONTENT & MARKETING
// ============================================================================

model Shared {
  id             String    @id @default(uuid())
  userId         String
  slug           String    @unique

  title          String?
  description    String?
  dateRange      Json

  desktop        Json      @default("[]")
  mobile         Json      @default("[]")

  accountNumbers String[]

  isPublic       Boolean   @default(true)
  expiresAt      DateTime?
  viewCount      Int       @default(0)

  createdAt      DateTime  @default(now())

  @@index([userId])
  @@index([slug])
  @@schema("public")
}

model Newsletter {
  email     String  @id @unique
  isActive  Boolean @default(true)
  firstName String?
  lastName  String?

  @@index([email])
  @@schema("public")
}

model SubscriptionFeedback {
  id                 String   @id @default(uuid())
  email              String
  event              String
  cancellationReason String?
  feedback           String?

  createdAt          DateTime @default(now())

  @@index([email])
  @@schema("public")
}

// ============================================================================
// ENUMS
// ============================================================================

enum PostType {
  FEATURE_REQUEST
  BUG_REPORT
  DISCUSSION

  @@schema("public")
}

enum PostStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CLOSED

  @@schema("public")
}

enum VoteType {
  UPVOTE
  DOWNVOTE

  @@schema("public")
}

enum PaymentFrequency {
  MONTHLY
  QUARTERLY
  BIANNUAL
  ANNUAL
  CUSTOM

  @@schema("public")
}

enum PromoType {
  DIRECT
  PERCENTAGE

  @@schema("public")
}

enum MemberRole {
  ADMIN
  TRADER
  ANALYST
  VIEWER

  @@schema("public")
}
