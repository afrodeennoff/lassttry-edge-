generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MemberRole {
  ADMIN
  TRADER
  ANALYST
  VIEWER
}

enum BillingProvider {
  STRIPE
  WHOP
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  PAYMENT_FAILED
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum TransactionType {
  SUBSCRIPTION
  RENEWAL
  ONE_TIME
  REFUND
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum RefundStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum SupportComplexity {
  LOW
  MEDIUM
  HIGH
}

enum JobStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
}

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  language         String   @default("en")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  accounts         Account[]
  trades           Trade[]
  payouts          Payout[]
  orders           Order[]
  groups           Group[]
  tags             Tag[]
  moods            Mood[]
  notifications    Notification[]
  dashboardLayout  DashboardLayout?
  layoutVersions   LayoutVersion[]
  subscriptions    Subscription[]
  transactions     PaymentTransaction[]
  invoices         Invoice[]
  refunds          Refund[]
  processedWebhooks ProcessedWebhook[]
  auditLogs        AuditLog[]
  teamMemberships  TeamMember[]
  businessMemberships BusinessMember[]
  organizationMemberships OrganizationMember[]
  supportTickets   SupportTicket[]
}

model Team {
  id          String           @id @default(cuid())
  name        String
  slug        String           @unique
  createdAt   DateTime         @default(now())
  members     TeamMember[]
  invitations TeamInvitation[]
  businesses  Business[]
  organizations Organization[]
}

model TeamMember {
  id        String     @id @default(cuid())
  teamId    String
  userId    String
  role      MemberRole @default(TRADER)
  createdAt DateTime   @default(now())
  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
}

model TeamInvitation {
  id        String           @id @default(cuid())
  teamId     String
  email      String
  role       MemberRole      @default(TRADER)
  status     InvitationStatus @default(PENDING)
  token      String          @unique
  expiresAt  DateTime
  createdAt  DateTime        @default(now())
  team       Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, email])
}

model Business {
  id             String   @id @default(cuid())
  name           String
  slug           String   @unique
  teamId         String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  team           Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  organizations  Organization[]
  members        BusinessMember[]
  invitations    BusinessInvitation[]
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  teamId      String?
  businessId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  team        Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  business    Business? @relation(fields: [businessId], references: [id], onDelete: SetNull)
  members     OrganizationMember[]
  invitations OrganizationInvitation[]
}

model BusinessMember {
  id         String     @id @default(cuid())
  businessId String
  userId     String
  role       MemberRole @default(TRADER)
  createdAt  DateTime   @default(now())
  business   Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([businessId, userId])
}

model BusinessInvitation {
  id         String           @id @default(cuid())
  businessId String
  email      String
  role       MemberRole       @default(TRADER)
  token      String           @unique
  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime
  createdAt  DateTime         @default(now())
  business   Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, email])
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  role           MemberRole   @default(TRADER)
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
}

model OrganizationInvitation {
  id             String           @id @default(cuid())
  organizationId String
  email          String
  role           MemberRole       @default(TRADER)
  token          String           @unique
  status         InvitationStatus @default(PENDING)
  expiresAt      DateTime
  createdAt      DateTime         @default(now())
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
}

model Group {
  id       String    @id @default(cuid())
  userId   String
  name     String
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accounts Account[]
  trades   Trade[]

  @@unique([userId, name])
}

model Account {
  id             String   @id @default(cuid())
  userId         String
  groupId        String?
  number         String
  provider       String
  startingBalance Float   @default(0)
  balance        Float    @default(0)
  drawdown       Float?
  target         Float?
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  group          Group?   @relation(fields: [groupId], references: [id], onDelete: SetNull)
  trades         Trade[]
  payouts        Payout[]

  @@unique([userId, number])
}

model Trade {
  id          String   @id @default(cuid())
  userId      String
  accountId   String
  groupId     String?
  instrument  String
  side        String
  quantity    Int
  entryPrice  Float
  closePrice  Float
  entryAt     DateTime
  closeAt     DateTime
  pnl         Float
  commission  Float    @default(0)
  mae         Float?
  mfe         Float?
  riskReward  Float?
  efficiency  Float?
  tags        String[] @default([])
  note        String?
  mood        String?
  images      String[] @default([])
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  group       Group?   @relation(fields: [groupId], references: [id], onDelete: SetNull)

  @@index([userId, instrument])
  @@index([entryAt])
  @@index([closeAt])
}

model Payout {
  id        String   @id @default(cuid())
  userId    String
  accountId String
  amount    Float
  paidAt    DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
}

model Order {
  id        String   @id @default(cuid())
  userId    String
  tradeId   String?
  symbol    String
  side      String
  price     Float
  quantity  Int
  status    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Tag {
  id      String @id @default(cuid())
  userId  String
  name    String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
}

model Mood {
  id      String   @id @default(cuid())
  userId  String
  day     DateTime
  score   Int
  notes   String?
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, day])
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String
  readAt      DateTime?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DashboardLayout {
  id        String   @id @default(cuid())
  userId    String   @unique
  desktop   Json
  mobile    Json
  version   Int      @default(1)
  checksum  String
  deviceId  String
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  history   LayoutVersion[]
}

model LayoutVersion {
  id         String          @id @default(cuid())
  userId     String
  layoutId   String
  version    Int
  desktop    Json
  mobile     Json
  checksum   String
  deviceId   String
  changeType String
  createdAt  DateTime        @default(now())
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  layout     DashboardLayout @relation(fields: [layoutId], references: [id], onDelete: Cascade)

  @@index([layoutId, version])
}

model SharedView {
  id        String   @id @default(cuid())
  userId    String
  slug      String   @unique
  payload   Json
  isPublic  Boolean  @default(false)
  expiresAt DateTime?
  viewCount Int      @default(0)
  createdAt DateTime @default(now())

  @@index([userId])
}

model Subscription {
  id                String             @id @default(cuid())
  userId            String
  email             String
  provider          BillingProvider
  externalId        String             @unique
  plan              String
  status            SubscriptionStatus @default(ACTIVE)
  interval          String
  trialEndsAt       DateTime?
  currentPeriodEnd  DateTime?
  cancelAtPeriodEnd Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
}

model PaymentTransaction {
  id                     String            @id @default(cuid())
  userId                 String
  email                  String
  provider               BillingProvider
  externalId             String            @unique
  subscriptionExternalId String?
  amount                 Float
  currency               String            @default("USD")
  type                   TransactionType
  status                 TransactionStatus @default(PENDING)
  metadata               Json?
  createdAt              DateTime          @default(now())
  user                   User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model Invoice {
  id        String          @id @default(cuid())
  userId    String
  email     String
  provider  BillingProvider
  externalId String         @unique
  amountDue Float
  amountPaid Float          @default(0)
  currency  String          @default("USD")
  status    InvoiceStatus   @default(OPEN)
  dueDate   DateTime?
  paidAt    DateTime?
  lines     Json
  createdAt DateTime        @default(now())
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Refund {
  id                    String       @id @default(cuid())
  userId                String
  email                 String
  provider              BillingProvider
  externalId            String       @unique
  transactionExternalId String
  amount                Float
  currency              String       @default("USD")
  status                RefundStatus @default(PENDING)
  reason                String?
  metadata              Json?
  createdAt             DateTime     @default(now())
  user                  User         @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProcessedWebhook {
  id         String          @id @default(cuid())
  userId     String?
  provider   BillingProvider
  eventId    String
  eventType  String
  payload    Json
  processedAt DateTime       @default(now())
  user       User?           @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([provider, eventId, eventType])
  @@index([processedAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  actor     String
  action    String
  entity    String
  entityId  String?
  metadata  Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt])
}

model SupportTicket {
  id           String            @id @default(cuid())
  userId        String?
  email         String?
  category      String
  complexity    SupportComplexity @default(LOW)
  message       String
  aiSuggestion  String?
  escalate      Boolean           @default(false)
  payload       Json?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  user          User?             @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([category, complexity])
  @@index([createdAt])
}

model NewsletterSubscriber {
  id         String   @id @default(cuid())
  email      String   @unique
  firstName  String?
  locale     String   @default("en")
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model JobRun {
  id          String    @id @default(cuid())
  name        String
  status      JobStatus @default(PENDING)
  startedAt   DateTime?
  finishedAt  DateTime?
  details     Json?
  createdAt   DateTime  @default(now())

  @@index([name, createdAt])
}
