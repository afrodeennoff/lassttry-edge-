name: Widget Policy Compliance Check

on:
  pull_request:
    paths:
      - 'app/**/widgets/**'
      - 'lib/widget-policy-engine/**'
      - 'schemas/**'
  push:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  POLICY_VERSION: '1.0.0'

jobs:
  validate-schemas:
    name: Validate JSON Schemas
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          
      - name: Validate schema syntax
        run: |
          npm run validate:schemas || echo "Schema validation skipped (add script to package.json)"
          
      - name: Check schema versions
        run: |
          node -e "
            const fs = require('fs');
            const schemas = ['schemas/widget-input.schema.json', 'schemas/widget-output.schema.json', 'schemas/widget-policy-manifest.schema.json'];
            schemas.forEach(schema => {
              try {
                const data = JSON.parse(fs.readFileSync(schema, 'utf8'));
                if (!data.\\$schema) {
                  console.error('Missing \\$schema in ' + schema);
                  process.exit(1);
                }
                console.log('‚úì ' + schema);
              } catch (e) {
                console.error('‚úó ' + schema + ': ' + e.message);
                process.exit(1);
              }
            });
          "

  check-policy-compliance:
    name: Check Widget Policy Compliance
    runs-on: ubuntu-latest
    needs: validate-schemas
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          
      - name: Run policy compliance tests
        run: |
          npm run test:policy || echo "Policy tests not configured, skipping"
          
      - name: Check for policy manifests
        run: |
          node .github/scripts/check-manifests.js
          
      - name: Validate risk registers
        run: |
          node .github/scripts/validate-risk-registers.js
          
      - name: Check for policy drift
        run: |
          npm run check:policy-drift || echo "Drift check not configured"

  run-monte-carlo-simulation:
    name: Monte Carlo Risk Simulation
    runs-on: ubuntu-latest
    needs: validate-schemas
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install dependencies
        run: npm ci
         
      - name: Run Monte Carlo simulation
        run: |
          node .github/scripts/run-monte-carlo.js
          
      - name: Upload simulation results
        uses: actions/upload-artifact@v4
        with:
          name: monte-carlo-results
          path: monte-carlo-results.json
          retention-days: 30

  check-test-coverage:
    name: Check Test Coverage
    runs-on: ubuntu-latest
    needs: validate-schemas
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install dependencies
        run: npm ci
         
      - name: Run tests with coverage
        run: |
          npm run test:coverage -- lib/widget-policy-engine || npm run test -- --coverage lib/widget-policy-engine
          
      - name: Check coverage threshold
        run: |
          node .github/scripts/check-coverage.js --threshold=90 --path=lib/widget-policy-engine

  validate-widget-integration:
    name: Validate Widget Integration
    runs-on: ubuntu-latest
    needs: check-policy-compliance
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install dependencies
        run: npm ci
          
      - name: Check widget imports
        run: |
          node .github/scripts/check-widget-imports.js
          
      - name: Validate WithRiskEvaluation usage
        run: |
          node .github/scripts/validate-risk-hoc-usage.js
          
      - name: Check error handling
        run: |
          node .github/scripts/check-error-handling.js

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: check-policy-compliance
    steps:
      - uses: actions/checkout@v4
      
      - name: Run security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          
      - name: Upload security results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  compliance-report:
    name: Generate Compliance Report
    runs-on: ubuntu-latest
    needs: [validate-schemas, check-policy-compliance, run-monte-carlo-simulation, check-test-coverage, validate-widget-integration]
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: Install dependencies
        run: npm ci
          
      - name: Generate compliance report
        run: |
          node .github/scripts/generate-compliance-report.js
          
      - name: Upload compliance report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: compliance-report.json
          retention-days: 90
          
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('compliance-report.json', 'utf8'));
            
            let comment = '## üîí Widget Policy Compliance Report\n\n';
            comment += `| Check | Status | Details |\n`;
            comment += `|-------|--------|--------|\n`;
            
            for (const [key, value] of Object.entries(report.results)) {
              const icon = value.passed ? '‚úÖ' : '‚ùå';
              comment += `| ${key} | ${icon} | ${value.message} |\n`;
            }
            
            comment += `\n**Overall Status:** ${report.overallCompliant ? '‚úÖ Compliant' : '‚ùå Non-Compliant'}\n`;
            comment += `\nCompliance Score: ${report.complianceScore}%\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [validate-schemas, check-policy-compliance, run-monte-carlo-simulation, check-test-coverage, validate-widget-integration]
    if: failure()
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Widget Policy Compliance Check Failed',
              body: 'The widget policy compliance check failed for commit ' + context.sha + '.\n\nPlease review the workflow logs and fix the issues.',
              labels: ['bug', 'compliance', 'priority:high']
            })
